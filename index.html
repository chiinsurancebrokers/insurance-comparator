<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Policy Comparator | Συγκριτικό Ασφαλιστικών</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Configure PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        const Shield = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
        );
        
        const Upload = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );
        
        const CheckCircle = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );
        
        const AlertCircle = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );
        
        const TrendingUp = () => (
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );
        
        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );
        
        const Save = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
        );

        function InsurancePolicyComparator() {
            const [userInfo, setUserInfo] = useState({
                firstName: '',
                lastName: '',
                dateOfBirth: '',
                nationality: '',
                citizenship: ''
            });
            
            const [policies, setPolicies] = useState([]);
            const [recommendation, setRecommendation] = useState(null);
            const [step, setStep] = useState(1);
            const [language, setLanguage] = useState('en');
            const [saveMessage, setSaveMessage] = useState('');
            
            // Load saved data on mount
            useEffect(() => {
                try {
                    const saved = sessionStorage.getItem('insuranceComparatorData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.userInfo) setUserInfo(data.userInfo);
                        if (data.policies) setPolicies(data.policies);
                        if (data.language) setLanguage(data.language);
                        if (data.step) setStep(data.step);
                        if (data.recommendation) setRecommendation(data.recommendation);
                    }
                } catch (error) {
                    console.log('No saved data or error loading:', error);
                }
            }, []);
            
            // Save data whenever it changes
            useEffect(() => {
                try {
                    const dataToSave = {
                        userInfo,
                        policies,
                        language,
                        step,
                        recommendation
                    };
                    sessionStorage.setItem('insuranceComparatorData', JSON.stringify(dataToSave));
                } catch (error) {
                    console.log('Error saving data:', error);
                }
            }, [userInfo, policies, language, step, recommendation]);
            
            const translations = {
                en: {
                    title: "Insurance Policy Comparator",
                    step1Title: "Personal Information",
                    step1Subtitle: "Help us personalize your insurance recommendations",
                    firstName: "First Name",
                    lastName: "Last Name",
                    dateOfBirth: "Date of Birth",
                    nationality: "Nationality",
                    citizenship: "Citizenship",
                    continue: "Continue to Upload Policies",
                    back: "Back",
                    step2Title: "Upload Policy Data",
                    step2Subtitle: "Upload CSV or JSON files with your insurance policies",
                    chooseFile: "Choose File",
                    acceptedFormats: "Accepted formats: CSV, JSON, PDF",
                    policiesLoaded: "policies loaded successfully",
                    analyzePolicies: "Analyze Policies",
                    recommendationFor: "Recommendation for",
                    age: "Age",
                    score: "Score",
                    annualPremium: "Annual Premium",
                    excessDeductible: "Excess/Deductible",
                    whyThisPolicy: "Why This Policy?",
                    detailedAnalysis: "Detailed Analysis",
                    benefitsIncluded: "Benefits Included",
                    exclusionsTitle: "Exclusions",
                    otherOptions: "Other Options Considered",
                    startNew: "Start New Comparison",
                    errorReading: "Error reading file. Please ensure it is a valid JSON or CSV file.",
                    completeInfo: "Please complete your information and upload policy data.",
                    clearAll: "Clear All Policies",
                    uploadAnother: "Upload Another File",
                    savings: "Annual Savings",
                    compared: "compared to",
                    keyAdvantages: "Key Advantages",
                    whenToConsider: "When to Consider Alternatives",
                    downloadReport: "Download Professional Report",
                    savingData: "Saving your progress...",
                    dataSaved: "Data saved!",
                    clearData: "Clear Saved Data",
                    affordablePremium: "Most Affordable Premium",
                    lowestCosts: "Lowest Out-of-Pocket Costs",
                    comprehensiveCoverage: "Comprehensive Coverage",
                    perfectAge: "Perfect for Your Age Group",
                    idealLocation: "Ideal for Greek Residents",
                    exceptionalValue: "Exceptional Value for Money",
                    benefits: "benefits",
                    exclusions: "exclusions",
                    perMonth: "per month",
                    lowestExcess: "Lowest excess",
                    savedEveryMonth: "saved every month",
                    otherOptionsText: "other options",
                    professionalAdvice: "Professional Insurance Advice Report"
                },
                gr: {
                    title: "Συγκριτικό Ασφαλιστικών Πολιτικών",
                    step1Title: "Προσωπικά Στοιχεία",
                    step1Subtitle: "Βοηθήστε μας να εξατομικεύσουμε τις ασφαλιστικές σας συστάσεις",
                    firstName: "Όνομα",
                    lastName: "Επώνυμο",
                    dateOfBirth: "Ημερομηνία Γέννησης",
                    nationality: "Εθνικότητα",
                    citizenship: "Υπηκοότητα",
                    continue: "Συνέχεια στη Μεταφόρτωση Πολιτικών",
                    back: "Πίσω",
                    step2Title: "Μεταφόρτωση Δεδομένων Πολιτικής",
                    step2Subtitle: "Μεταφορτώστε αρχεία CSV ή JSON με τις ασφαλιστικές σας πολιτικές",
                    chooseFile: "Επιλογή Αρχείου",
                    acceptedFormats: "Αποδεκτές μορφές: CSV, JSON, PDF",
                    policiesLoaded: "πολιτικές φορτώθηκαν επιτυχώς",
                    analyzePolicies: "Ανάλυση Πολιτικών",
                    recommendationFor: "Σύσταση για",
                    age: "Ηλικία",
                    score: "Βαθμολογία",
                    annualPremium: "Ετήσιο Ασφάλιστρο",
                    excessDeductible: "Απαλλαγή",
                    whyThisPolicy: "Γιατί Αυτή η Πολιτική;",
                    detailedAnalysis: "Λεπτομερής Ανάλυση",
                    benefitsIncluded: "Παροχές που Περιλαμβάνονται",
                    exclusionsTitle: "Εξαιρέσεις",
                    otherOptions: "Άλλες Επιλογές που Εξετάστηκαν",
                    startNew: "Έναρξη Νέας Σύγκρισης",
                    errorReading: "Σφάλμα ανάγνωσης αρχείου. Βεβαιωθείτε ότι είναι έγκυρο αρχείο JSON ή CSV.",
                    completeInfo: "Παρακαλώ συμπληρώστε τα στοιχεία σας και μεταφορτώστε δεδομένα πολιτικής.",
                    clearAll: "Εκκαθάριση Όλων των Πολιτικών",
                    uploadAnother: "Μεταφόρτωση Άλλου Αρχείου",
                    savings: "Ετήσια Εξοικονόμηση",
                    compared: "σε σύγκριση με",
                    keyAdvantages: "Βασικά Πλεονεκτήματα",
                    whenToConsider: "Πότε να Εξετάσετε Εναλλακτικές",
                    downloadReport: "Λήψη Επαγγελματικής Αναφοράς",
                    savingData: "Αποθήκευση προόδου...",
                    dataSaved: "Τα δεδομένα αποθηκεύτηκαν!",
                    clearData: "Διαγραφή Αποθηκευμένων Δεδομένων",
                    affordablePremium: "Πιο Προσιτό Ασφάλιστρο",
                    lowestCosts: "Χαμηλότερα Έξοδα από την Τσέπη",
                    comprehensiveCoverage: "Ολοκληρωμένη Κάλυψη",
                    perfectAge: "Ιδανικό για την Ηλικιακή σας Ομάδα",
                    idealLocation: "Ιδανικό για Κατοίκους Ελλάδας",
                    exceptionalValue: "Εξαιρετική Σχέση Ποιότητας-Τιμής",
                    benefits: "παροχές",
                    exclusions: "εξαιρέσεις",
                    perMonth: "το μήνα",
                    lowestExcess: "Χαμηλότερη απαλλαγή",
                    savedEveryMonth: "εξοικονόμηση κάθε μήνα",
                    otherOptionsText: "άλλες επιλογές",
                    professionalAdvice: "Επαγγελματική Αναφορά Ασφαλιστικών Συμβουλών"
                }
            };
            
            const t = translations[language];
            
            const calculateAge = (dob) => {
                const today = new Date();
                const birthDate = new Date(dob);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };
            
            const parsePDFFile = async (file) => {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    
                    // Try to parse structured data from PDF text
                    // This is a simplified parser - adjust based on your PDF format
                    const policies = [];
                    const lines = fullText.split('\n').filter(line => line.trim());
                    
                    // Example parsing logic - adjust based on actual PDF structure
                    let currentPolicy = {};
                    for (let line of lines) {
                        if (line.includes('Policy Name:') || line.includes('Όνομα Πολιτικής:')) {
                            if (currentPolicy.policyName) {
                                policies.push(currentPolicy);
                                currentPolicy = {};
                            }
                            currentPolicy.policyName = line.split(':')[1]?.trim();
                        } else if (line.includes('Premium:') || line.includes('Ασφάλιστρο:')) {
                            const match = line.match(/[\d,]+/);
                            if (match) currentPolicy.premium = parseFloat(match[0].replace(',', ''));
                        } else if (line.includes('Excess:') || line.includes('Απαλλαγή:')) {
                            const match = line.match(/[\d,]+/);
                            if (match) currentPolicy.excess = parseFloat(match[0].replace(',', ''));
                        } else if (line.includes('Provider:') || line.includes('Πάροχος:')) {
                            currentPolicy.provider = line.split(':')[1]?.trim();
                        }
                    }
                    
                    if (currentPolicy.policyName) {
                        policies.push(currentPolicy);
                    }
                    
                    return policies.length > 0 ? policies : null;
                } catch (error) {
                    console.error('PDF parsing error:', error);
                    return null;
                }
            };
            
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    let parsedPolicies;
                    
                    if (file.name.endsWith('.pdf')) {
                        parsedPolicies = await parsePDFFile(file);
                        if (!parsedPolicies) {
                            alert(language === 'en' 
                                ? 'Could not extract policy data from PDF. Please ensure it contains structured policy information or use CSV/JSON format.'
                                : 'Δεν ήταν δυνατή η εξαγωγή δεδομένων πολιτικής από το PDF. Βεβαιωθείτε ότι περιέχει δομημένες πληροφορίες πολιτικής ή χρησιμοποιήστε μορφή CSV/JSON.');
                            return;
                        }
                    } else {
                        const text = await file.text();
                        
                        if (file.name.endsWith('.json')) {
                            parsedPolicies = JSON.parse(text);
                        } else if (file.name.endsWith('.csv')) {
                            const result = Papa.parse(text, { 
                                header: true, 
                                dynamicTyping: true, 
                                skipEmptyLines: true
                            });
                            parsedPolicies = result.data;
                        }
                    }

                    setPolicies(prev => {
                        const newPolicies = Array.isArray(parsedPolicies) ? parsedPolicies : [parsedPolicies];
                        return [...prev, ...newPolicies];
                    });
                    
                    setSaveMessage(t.dataSaved);
                    setTimeout(() => setSaveMessage(''), 2000);
                } catch (error) {
                    alert(t.errorReading);
                }
            };
            
            const getDetailedReasoning = (policy, allPolicies, age) => {
                const reasons = [];
                
                // Premium comparison
                const avgPremium = allPolicies.reduce((sum, p) => sum + p.premium, 0) / allPolicies.length;
                const premiumDiff = ((avgPremium - policy.premium) / avgPremium * 100).toFixed(0);
                
                if (policy.premium < avgPremium) {
                    reasons.push({
                        type: 'positive',
                        title: `💰 ${t.affordablePremium}`,
                        detail: language === 'en' 
                            ? `At €${policy.premium}/year, this policy is ${premiumDiff}% cheaper than the average (€${avgPremium.toFixed(0)}). You save significantly on annual costs while maintaining comprehensive coverage.`
                            : `Στα €${policy.premium}/έτος, αυτή η πολιτική είναι ${premiumDiff}% φθηνότερη από το μέσο όρο (€${avgPremium.toFixed(0)}). Εξοικονομείτε σημαντικά στο ετήσιο κόστος διατηρώντας ολοκληρωμένη κάλυψη.`
                    });
                }
                
                // Excess comparison
                const avgExcess = allPolicies.reduce((sum, p) => sum + p.excess, 0) / allPolicies.length;
                if (policy.excess < avgExcess) {
                    const excessDiff = avgExcess - policy.excess;
                    reasons.push({
                        type: 'positive',
                        title: `💳 ${t.lowestCosts}`,
                        detail: language === 'en'
                            ? `With only €${policy.excess} excess, you pay €${excessDiff.toFixed(0)} less per claim compared to the average (€${avgExcess.toFixed(0)}). This means lower immediate costs when you need medical care.`
                            : `Με μόνο €${policy.excess} απαλλαγή, πληρώνετε €${excessDiff.toFixed(0)} λιγότερα ανά αξίωση σε σύγκριση με το μέσο όρο (€${avgExcess.toFixed(0)}). Αυτό σημαίνει χαμηλότερα άμεσα έξοδα όταν χρειάζεστε ιατρική φροντίδα.`
                    });
                }
                
                // Benefits analysis
                const benefitCount = policy.benefits ? (Array.isArray(policy.benefits) ? policy.benefits.length : String(policy.benefits).split(',').length) : 0;
                if (benefitCount > 15) {
                    reasons.push({
                        type: 'positive',
                        title: `🏥 ${t.comprehensiveCoverage}`,
                        detail: language === 'en'
                            ? `Includes ${benefitCount} different benefits covering hospital care, emergency services, maternity, dental emergencies, and 24/7 support. This extensive coverage ensures you're protected in various medical situations.`
                            : `Περιλαμβάνει ${benefitCount} διαφορετικές παροχές που καλύπτουν νοσοκομειακή φροντίδα, επείγοντα περιστατικά, μητρότητα, οδοντιατρικά επείγοντα και υποστήριξη 24/7. Αυτή η εκτεταμένη κάλυψη διασφαλίζει ότι είστε προστατευμένοι σε διάφορες ιατρικές καταστάσεις.`
                    });
                }
                
                // Age-specific benefits
                if (age > 45 && policy.benefits && String(policy.benefits).toLowerCase().includes('chronic')) {
                    reasons.push({
                        type: 'positive',
                        title: `👤 ${t.perfectAge}`,
                        detail: language === 'en'
                            ? `At age ${age}, you benefit from chronic condition coverage, which becomes increasingly important. This policy provides appropriate protection for age-related health needs.`
                            : `Σε ηλικία ${age}, επωφελείστε από την κάλυψη χρόνιων παθήσεων, που γίνεται όλο και πιο σημαντική. Αυτή η πολιτική παρέχει κατάλληλη προστασία για τις ηλικιακές υγειονομικές ανάγκες.`
                    });
                }
                
                // Geographic coverage
                if (policy.provider && (policy.provider.includes('Greece') || policy.provider.includes('Europe'))) {
                    reasons.push({
                        type: 'positive',
                        title: `🌍 ${t.idealLocation}`,
                        detail: language === 'en'
                            ? `Strong network in Greece and Europe means easier access to hospitals, lower administrative hassle, and no need to pay for unnecessary worldwide coverage if you don't travel internationally often.`
                            : `Ισχυρό δίκτυο στην Ελλάδα και Ευρώπη σημαίνει ευκολότερη πρόσβαση σε νοσοκομεία, χαμηλότερο διοικητικό φόρτο και δεν χρειάζεται να πληρώσετε για περιττή παγκόσμια κάλυψη αν δεν ταξιδεύετε συχνά διεθνώς.`
                    });
                }
                
                // Value proposition
                const valueScore = (1000 / policy.premium) * (benefitCount / 10) * (1000 / (policy.excess + 1));
                if (valueScore > 50) {
                    reasons.push({
                        type: 'positive',
                        title: `⭐ ${t.exceptionalValue}`,
                        detail: language === 'en'
                            ? `When considering the balance of low premium, low excess, and comprehensive benefits, this policy offers outstanding value. You get maximum protection for minimum cost.`
                            : `Λαμβάνοντας υπόψη την ισορροπία χαμηλού ασφαλίστρου, χαμηλής απαλλαγής και ολοκληρωμένων παροχών, αυτή η πολιτική προσφέρει εξαιρετική αξία. Λαμβάνετε μέγιστη προστασία με ελάχιστο κόστος.`
                    });
                }
                
                return reasons;
            };
            
            const downloadProfessionalReport = () => {
                if (!recommendation || recommendation.length === 0) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const bestPolicy = recommendation[0];
                const age = calculateAge(userInfo.dateOfBirth);
                const otherPolicies = recommendation.slice(1);
                const avgOtherPremium = otherPolicies.length > 0 
                    ? otherPolicies.reduce((sum, p) => sum + p.premium, 0) / otherPolicies.length 
                    : 0;
                const savings = avgOtherPremium - bestPolicy.premium;
                
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPos = 20;
                
                // Header
                doc.setFillColor(37, 99, 235);
                doc.rect(0, 0, pageWidth, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.text(t.professionalAdvice, pageWidth / 2, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.text(new Date().toLocaleDateString(), pageWidth / 2, 25, { align: 'center' });
                doc.text(`${language === 'en' ? 'Prepared for' : 'Προετοιμάστηκε για'}: ${userInfo.firstName} ${userInfo.lastName}`, pageWidth / 2, 32, { align: 'center' });
                
                yPos = 50;
                doc.setTextColor(0, 0, 0);
                
                // Client Information
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(language === 'en' ? 'Client Information' : 'Στοιχεία Πελάτη', 14, yPos);
                yPos += 8;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${t.firstName}: ${userInfo.firstName} ${userInfo.lastName}`, 14, yPos);
                yPos += 6;
                doc.text(`${t.age}: ${age}`, 14, yPos);
                yPos += 6;
                doc.text(`${t.nationality}: ${userInfo.nationality}`, 14, yPos);
                yPos += 12;
                
                // Recommended Policy
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 128, 0);
                doc.text(language === 'en' ? 'RECOMMENDED POLICY' : 'ΣΥΝΙΣΤΩΜΕΝΗ ΠΟΛΙΤΙΚΗ', 14, yPos);
                yPos += 8;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.text(bestPolicy.policyName, 14, yPos);
                yPos += 6;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${language === 'en' ? 'Provider' : 'Πάροχος'}: ${bestPolicy.provider}`, 14, yPos);
                yPos += 6;
                doc.text(`${t.score}: ${bestPolicy.totalScore}/100`, 14, yPos);
                yPos += 10;
                
                // Financial Details
                doc.setFillColor(240, 253, 244);
                doc.rect(14, yPos - 5, pageWidth - 28, 25, 'F');
                doc.setFont(undefined, 'bold');
                doc.text(`${t.annualPremium}: €${bestPolicy.premium}/year (€${(bestPolicy.premium/12).toFixed(2)}/${t.perMonth})`, 18, yPos);
                yPos += 6;
                doc.text(`${t.excessDeductible}: €${bestPolicy.excess}`, 18, yPos);
                yPos += 8;
                if (savings > 0) {
                    doc.setTextColor(255, 140, 0);
                    doc.text(`${t.savings}: €${savings.toFixed(0)} (€${(savings/12).toFixed(2)} ${t.savedEveryMonth})`, 18, yPos);
                    doc.setTextColor(0, 0, 0);
                }
                yPos += 12;
                doc.setFont(undefined, 'normal');
                
                // Key Analysis Points
                if (bestPolicy.detailedReasons && bestPolicy.detailedReasons.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(t.detailedAnalysis, 14, yPos);
                    yPos += 8;
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    
                    bestPolicy.detailedReasons.forEach((reason, idx) => {
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.setFont(undefined, 'bold');
                        const title = reason.title.replace(/[^\w\s]/gi, '');
                        doc.text(`${idx + 1}. ${title}`, 14, yPos);
                        yPos += 5;
                        doc.setFont(undefined, 'normal');
                        const lines = doc.splitTextToSize(reason.detail, pageWidth - 30);
                        doc.text(lines, 18, yPos);
                        yPos += lines.length * 5 + 3;
                    });
                }
                
                // Benefits
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }
                yPos += 5;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${t.benefitsIncluded} (${bestPolicy.benefitCount})`, 14, yPos);
                yPos += 7;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const benefits = Array.isArray(bestPolicy.benefits) ? bestPolicy.benefits.join(', ') : bestPolicy.benefits;
                const benefitLines = doc.splitTextToSize(benefits, pageWidth - 28);
                doc.text(benefitLines, 14, yPos);
                yPos += benefitLines.length * 5 + 8;
                
                // Exclusions
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${t.exclusionsTitle} (${bestPolicy.exclusionCount})`, 14, yPos);
                yPos += 7;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const exclusions = Array.isArray(bestPolicy.exclusions) ? bestPolicy.exclusions.join(', ') : bestPolicy.exclusions;
                const exclusionLines = doc.splitTextToSize(exclusions, pageWidth - 28);
                doc.text(exclusionLines, 14, yPos);
                yPos += exclusionLines.length * 5 + 10;
                
                // Alternative Options
                if (recommendation.length > 1) {
                    if (yPos > 200) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(t.otherOptions, 14, yPos);
                    yPos += 8;
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    
                    recommendation.slice(1, 4).forEach((policy, idx) => {
                        if (yPos > 260) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx + 2}. ${policy.policyName}`, 14, yPos);
                        yPos += 5;
                        doc.setFont(undefined, 'normal');
                        doc.text(`${language === 'en' ? 'Score' : 'Βαθμολογία'}: ${policy.totalScore}/100 | ${t.annualPremium}: €${policy.premium} | ${t.excessDeductible}: €${policy.excess}`, 18, yPos);
                        yPos += 8;
                    });
                }
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                const footerY = doc.internal.pageSize.getHeight() - 10;
                doc.text(language === 'en' 
                    ? 'This is a professional analysis based on the data provided. Please verify all details with the insurance provider.'
                    : 'Αυτή είναι μια επαγγελματική ανάλυση βασισμένη στα παρεχόμενα δεδομένα. Παρακαλώ επιβεβαιώστε όλες τις λεπτομέρειες με τον πάροχο ασφάλισης.',
                    pageWidth / 2, footerY, { align: 'center' });
                
                // Save
                const filename = `Insurance_Analysis_${userInfo.lastName}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
            };
            
            const analyzePolicies = () => {
                if (!userInfo.dateOfBirth || policies.length === 0) {
                    alert(t.completeInfo);
                    return;
                }

                const age = calculateAge(userInfo.dateOfBirth);
                
                const scoredPolicies = policies.map(policy => {
                    let score = 0;
                    let reasoning = [];

                    const premiumScore = policy.premium ? Math.max(0, 100 - (policy.premium / 50)) : 50;
                    score += premiumScore * 0.35;

                    const excessScore = policy.excess ? Math.max(0, 100 - (policy.excess / 20)) : 50;
                    score += excessScore * 0.20;

                    const benefitCount = policy.benefits ? (Array.isArray(policy.benefits) ? policy.benefits.length : String(policy.benefits).split(',').length) : 0;
                    const benefitScore = Math.min(100, benefitCount * 10);
                    score += benefitScore * 0.30;

                    const exclusionCount = policy.exclusions ? (Array.isArray(policy.exclusions) ? policy.exclusions.length : String(policy.exclusions).split(',').length) : 0;
                    const exclusionScore = Math.max(0, 100 - (exclusionCount * 15));
                    score += exclusionScore * 0.15;

                    return {
                        ...policy,
                        totalScore: Math.round(score * 10) / 10,
                        reasoning,
                        benefitCount,
                        exclusionCount
                    };
                });

                scoredPolicies.sort((a, b) => b.totalScore - a.totalScore);
                
                // Add detailed reasoning to top policy
                scoredPolicies[0].detailedReasons = getDetailedReasoning(scoredPolicies[0], scoredPolicies, age);
                
                setRecommendation(scoredPolicies);
                setStep(3);
            };
            
            const renderStep1 = () => (
                <div className="space-y-6">
                    <div className="text-center mb-8">
                        <div className="w-16 h-16 text-blue-600 mx-auto mb-4 flex items-center justify-center">
                            <Shield />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800">{t.step1Title}</h2>
                        <p className="text-gray-600 mt-2">{t.step1Subtitle}</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">{t.firstName}</label>
                            <input
                                type="text"
                                value={userInfo.firstName}
                                onChange={(e) => setUserInfo(prev => ({ ...prev, firstName: e.target.value }))}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'en' ? 'John' : 'Γιάννης'}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">{t.lastName}</label>
                            <input
                                type="text"
                                value={userInfo.lastName}
                                onChange={(e) => setUserInfo(prev => ({ ...prev, lastName: e.target.value }))}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'en' ? 'Doe' : 'Παπαδόπουλος'}
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">{t.dateOfBirth}</label>
                        <input
                            type="date"
                            value={userInfo.dateOfBirth}
                            onChange={(e) => setUserInfo(prev => ({ ...prev, dateOfBirth: e.target.value }))}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">{t.nationality}</label>
                            <input
                                type="text"
                                value={userInfo.nationality}
                                onChange={(e) => setUserInfo(prev => ({ ...prev, nationality: e.target.value }))}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'en' ? 'American' : 'Ελληνική'}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">{t.citizenship}</label>
                            <input
                                type="text"
                                value={userInfo.citizenship}
                                onChange={(e) => setUserInfo(prev => ({ ...prev, citizenship: e.target.value }))}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'en' ? 'United States' : 'Ελλάδα'}
                            />
                        </div>
                    </div>

                    <button
                        onClick={() => setStep(2)}
                        disabled={!userInfo.firstName || !userInfo.lastName || !userInfo.dateOfBirth}
                        className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                    >
                        {t.continue}
                    </button>
                </div>
            );
            
            const renderStep2 = () => (
                <div className="space-y-6">
                    <div className="text-center mb-8">
                        <div className="w-16 h-16 text-blue-600 mx-auto mb-4 flex items-center justify-center">
                            <Upload />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800">{t.step2Title}</h2>
                        <p className="text-gray-600 mt-2">{t.step2Subtitle}</p>
                    </div>

                    <div className="bg-blue-50 border-2 border-blue-200 border-dashed rounded-lg p-8 text-center">
                        <label className="cursor-pointer">
                            <span className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 inline-block">
                                {t.chooseFile}
                            </span>
                            <input
                                type="file"
                                accept=".csv,.json,.pdf"
                                onChange={handleFileUpload}
                                className="hidden"
                            />
                        </label>
                        <p className="text-sm text-gray-600 mt-4">{t.acceptedFormats}</p>
                        <p className="text-xs text-gray-500 mt-2">{language === 'en' ? 'PDF support now available!' : 'Η υποστήριξη PDF είναι πλέον διαθέσιμη!'}</p>
                    </div>

                    {policies.length > 0 && (
                        <div className="space-y-3">
                            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <CheckCircle />
                                        <span className="text-green-800 font-medium">{policies.length} {t.policiesLoaded}</span>
                                    </div>
                                    <button
                                        onClick={() => setPolicies([])}
                                        className="text-sm text-red-600 hover:text-red-700 font-medium"
                                    >
                                        {t.clearAll}
                                    </button>
                                </div>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                                <p className="text-sm text-blue-700">{t.uploadAnother}</p>
                            </div>
                        </div>
                    )}

                    <div className="flex gap-4">
                        <button
                            onClick={() => setStep(1)}
                            className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
                        >
                            {t.back}
                        </button>
                        <button
                            onClick={analyzePolicies}
                            disabled={policies.length === 0}
                            className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                        >
                            {t.analyzePolicies}
                        </button>
                    </div>
                </div>
            );
            
            const renderStep3 = () => {
                if (!recommendation || recommendation.length === 0) return null;

                const bestPolicy = recommendation[0];
                const age = calculateAge(userInfo.dateOfBirth);
                
                // Calculate savings
                const otherPolicies = recommendation.slice(1);
                const avgOtherPremium = otherPolicies.length > 0 
                    ? otherPolicies.reduce((sum, p) => sum + p.premium, 0) / otherPolicies.length 
                    : 0;
                const savings = avgOtherPremium - bestPolicy.premium;

                return (
                    <div className="space-y-6">
                        <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-6">
                            <div className="flex items-center gap-3 mb-2">
                                <TrendingUp />
                                <div>
                                    <h2 className="text-2xl font-bold">{t.recommendationFor} {userInfo.firstName} {userInfo.lastName}</h2>
                                    <p className="text-blue-100">{t.age}: {age} | {userInfo.nationality}</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-green-50 border-2 border-green-500 rounded-lg p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-2xl font-bold text-gray-800">{bestPolicy.policyName}</h3>
                                <span className="bg-green-500 text-white px-4 py-2 rounded-full font-bold">
                                    {t.score}: {bestPolicy.totalScore}/100
                                </span>
                            </div>
                            <p className="text-lg text-gray-700 mb-4">{bestPolicy.provider}</p>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-white rounded-lg p-4 border-2 border-green-300">
                                    <p className="text-sm text-gray-600">{t.annualPremium}</p>
                                    <p className="text-3xl font-bold text-green-600">€{bestPolicy.premium}</p>
                                    <p className="text-xs text-gray-500 mt-1">€{(bestPolicy.premium/12).toFixed(2)}/{t.perMonth}</p>
                                </div>
                                <div className="bg-white rounded-lg p-4 border-2 border-blue-300">
                                    <p className="text-sm text-gray-600">{t.excessDeductible}</p>
                                    <p className="text-3xl font-bold text-blue-600">€{bestPolicy.excess}</p>
                                    <p className="text-xs text-green-600 mt-1">✓ {t.lowestExcess}</p>
                                </div>
                            </div>

                            {savings > 0 && (
                                <div className="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-2xl">💰</span>
                                        <h4 className="font-bold text-yellow-900 text-lg">{t.savings}</h4>
                                    </div>
                                    <p className="text-yellow-900">
                                        <span className="text-3xl font-bold">€{savings.toFixed(0)}</span>
                                        <span className="text-sm ml-2">{t.compared} {t.otherOptionsText}</span>
                                    </p>
                                    <p className="text-sm text-yellow-800 mt-1">
                                        {language === 'en' 
                                            ? `That's €${(savings/12).toFixed(2)} ${t.savedEveryMonth}!` 
                                            : `Αυτό είναι €${(savings/12).toFixed(2)} ${t.savedEveryMonth}!`}
                                    </p>
                                </div>
                            )}

                            {bestPolicy.detailedReasons && bestPolicy.detailedReasons.length > 0 && (
                                <div className="bg-white rounded-lg p-6 mb-6 border-2 border-green-200">
                                    <h4 className="font-bold text-gray-900 text-xl mb-4 flex items-center gap-2">
                                        <span>🎯</span> {t.detailedAnalysis}
                                    </h4>
                                    <div className="space-y-4">
                                        {bestPolicy.detailedReasons.map((reason, idx) => (
                                            <div key={idx} className="border-l-4 border-green-500 pl-4 py-2 bg-green-50 rounded-r">
                                                <h5 className="font-semibold text-gray-900 mb-1">{reason.title}</h5>
                                                <p className="text-sm text-gray-700 leading-relaxed">{reason.detail}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-1 gap-4 mb-4">
                                <div className="bg-white rounded-lg p-4 border border-gray-200">
                                    <h4 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <CheckCircle />
                                        {t.benefitsIncluded} ({bestPolicy.benefitCount})
                                    </h4>
                                    <p className="text-sm text-gray-600 leading-relaxed">
                                        {Array.isArray(bestPolicy.benefits) 
                                            ? bestPolicy.benefits.join(', ') 
                                            : bestPolicy.benefits}
                                    </p>
                                </div>
                                <div className="bg-white rounded-lg p-4 border border-gray-200">
                                    <h4 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <AlertCircle />
                                        {t.exclusionsTitle} ({bestPolicy.exclusionCount})
                                    </h4>
                                    <p className="text-sm text-gray-600 leading-relaxed">
                                        {Array.isArray(bestPolicy.exclusions) 
                                            ? bestPolicy.exclusions.join(', ') 
                                            : bestPolicy.exclusions}
                                    </p>
                                </div>
                            </div>

                            {recommendation.length > 1 && (
                                <div className="bg-gray-50 rounded-lg p-4 border border-gray-300">
                                    <h4 className="font-semibold text-gray-800 mb-2">⚠️ {t.whenToConsider}:</h4>
                                    <ul className="text-sm text-gray-700 space-y-1 ml-4">
                                        <li>• {language === 'en' 
                                            ? 'Need frequent international travel outside Europe' 
                                            : 'Χρειάζεστε συχνά διεθνή ταξίδια εκτός Ευρώπης'}</li>
                                        <li>• {language === 'en' 
                                            ? 'Require unlimited outpatient visits' 
                                            : 'Απαιτείτε απεριόριστες εξωνοσοκομειακές επισκέψεις'}</li>
                                        <li>• {language === 'en' 
                                            ? 'Need very high hospital coverage limits' 
                                            : 'Χρειάζεστε πολύ υψηλά όρια νοσοκομειακής κάλυψης'}</li>
                                    </ul>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-4">
                            <button
                                onClick={downloadProfessionalReport}
                                className="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2"
                            >
                                <Download />
                                {t.downloadReport}
                            </button>
                        </div>

                        {recommendation.length > 1 && (
                            <div className="space-y-4">
                                <h3 className="text-xl font-bold text-gray-800">{t.otherOptions}</h3>
                                {recommendation.slice(1).map((policy, idx) => (
                                    <div key={idx} className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <h4 className="text-lg font-semibold text-gray-800">{policy.policyName}</h4>
                                            <span className="bg-gray-200 text-gray-700 px-3 py-1 rounded-full font-semibold">
                                                {t.score}: {policy.totalScore}/100
                                            </span>
                                        </div>
                                        <p className="text-gray-600 mb-2">{policy.provider}</p>
                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                            <p><span className="font-medium">{t.annualPremium}:</span> €{policy.premium}</p>
                                            <p><span className="font-medium">{t.excessDeductible}:</span> €{policy.excess}</p>
                                        </div>
                                        <div className="mt-2 text-xs text-gray-500">
                                            <span>{policy.benefitCount} {t.benefits}</span>
                                            <span className="mx-2">•</span>
                                            <span>{policy.exclusionCount} {t.exclusions}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        <button
                            onClick={() => {
                                setStep(1);
                                setPolicies([]);
                                setRecommendation(null);
                            }}
                            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                        >
                            {t.startNew}
                        </button>
                    </div>
                );
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-8">
                            <div className="flex justify-between items-start mb-8">
                                <div className="flex-1">
                                    <h1 className="text-3xl font-bold text-gray-800">{t.title}</h1>
                                    {saveMessage && (
                                        <div className="flex items-center gap-2 mt-2 text-green-600 text-sm">
                                            <Save />
                                            <span>{saveMessage}</span>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setLanguage('en')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            language === 'en' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'
                                        }`}
                                    >
                                        EN
                                    </button>
                                    <button
                                        onClick={() => setLanguage('gr')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            language === 'gr' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'
                                        }`}
                                    >
                                        ΕΛ
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (confirm(language === 'en' 
                                                ? 'Clear all saved data?' 
                                                : 'Διαγραφή όλων των αποθηκευμένων δεδομένων;')) {
                                                sessionStorage.removeItem('insuranceComparatorData');
                                                window.location.reload();
                                            }
                                        }}
                                        className="px-3 py-2 rounded-lg bg-red-100 text-red-600 hover:bg-red-200 transition text-sm"
                                        title={t.clearData}
                                    >
                                        🗑️
                                    </button>
                                </div>
                            </div>

                            {step === 1 && renderStep1()}
                            {step === 2 && renderStep2()}
                            {step === 3 && renderStep3()}
                        </div>
                        
                        <footer className="text-center mt-8 text-gray-600 text-sm">
                            <p>© 2025 Insurance Policy Comparator | {language === 'en' ? 'Made with ❤️ for better decisions' : 'Φτιαγμένο με ❤️ για καλύτερες αποφάσεις'}</p>
                        </footer>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<InsurancePolicyComparator />, document.getElementById('root'));
    </script>
</body>
</html>
